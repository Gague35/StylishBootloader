#include <Uefi.h>
#include "Graphics.h"

// ============================================================================
// BITMAP FONT 8x8
// ============================================================================

// Font 8x8 - Chaque caractère = 8 lignes de 8 pixels
// Bit 1 = pixel blanc, Bit 0 = transparent
static const UINT8 font8x8_basic[128][8] = {
    [0]   = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // NUL
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Espace
    ['0'] = {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00},
    ['1'] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['2'] = {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x00},
    ['3'] = {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00},
    ['4'] = {0x0C, 0x1C, 0x2C, 0x4C, 0x7E, 0x0C, 0x0C, 0x00},
    ['5'] = {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00},
    ['6'] = {0x3C, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00},
    ['7'] = {0x7E, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    ['8'] = {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00},
    ['9'] = {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00},
    ['A'] = {0x18, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x00},
    ['B'] = {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00},
    ['C'] = {0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00},
    ['D'] = {0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00},
    ['E'] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00},
    ['F'] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00},
    ['G'] = {0x3C, 0x42, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00},
    ['H'] = {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00},
    ['I'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['J'] = {0x06, 0x06, 0x06, 0x06, 0x06, 0x46, 0x3C, 0x00},
    ['K'] = {0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00},
    ['L'] = {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00},
    ['M'] = {0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00},
    ['N'] = {0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x00},
    ['O'] = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['P'] = {0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x00},
    ['Q'] = {0x3C, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0x00},
    ['R'] = {0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x00},
    ['S'] = {0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00},
    ['T'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['U'] = {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['V'] = {0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00},
    ['W'] = {0x42, 0x42, 0x42, 0x42, 0x5A, 0x66, 0x42, 0x00},
    ['X'] = {0x42, 0x42, 0x24, 0x18, 0x24, 0x42, 0x42, 0x00},
    ['Y'] = {0x42, 0x42, 0x24, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['Z'] = {0x7E, 0x02, 0x04, 0x18, 0x20, 0x40, 0x7E, 0x00},
    ['a'] = {0x00, 0x00, 0x3C, 0x02, 0x3E, 0x42, 0x3E, 0x00},
    ['b'] = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x62, 0x5C, 0x00},
    ['c'] = {0x00, 0x00, 0x3C, 0x42, 0x40, 0x42, 0x3C, 0x00},
    ['d'] = {0x02, 0x02, 0x3A, 0x46, 0x42, 0x46, 0x3A, 0x00},
    ['e'] = {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x3C, 0x00},
    ['f'] = {0x0C, 0x12, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x00},
    ['g'] = {0x00, 0x00, 0x3A, 0x46, 0x42, 0x3E, 0x02, 0x3C},
    ['h'] = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00},
    ['i'] = {0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x1C, 0x00},
    ['j'] = {0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x44, 0x38},
    ['k'] = {0x40, 0x40, 0x44, 0x48, 0x70, 0x48, 0x44, 0x00},
    ['l'] = {0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C, 0x00},
    ['m'] = {0x00, 0x00, 0x76, 0x49, 0x49, 0x49, 0x49, 0x00},
    ['n'] = {0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00},
    ['o'] = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['p'] = {0x00, 0x00, 0x5C, 0x62, 0x42, 0x62, 0x5C, 0x40},
    ['q'] = {0x00, 0x00, 0x3A, 0x46, 0x42, 0x46, 0x3A, 0x02},
    ['r'] = {0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x00},
    ['s'] = {0x00, 0x00, 0x3E, 0x40, 0x3C, 0x02, 0x7C, 0x00},
    ['t'] = {0x10, 0x10, 0x7C, 0x10, 0x10, 0x12, 0x0C, 0x00},
    ['u'] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00},
    ['v'] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00},
    ['w'] = {0x00, 0x00, 0x41, 0x49, 0x49, 0x49, 0x36, 0x00},
    ['x'] = {0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00},
    ['y'] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x3C},
    ['z'] = {0x00, 0x00, 0x7E, 0x04, 0x18, 0x20, 0x7E, 0x00},
};

// ============================================================================
// FONCTIONS DE RENDU
// ============================================================================

VOID DrawChar(CHAR16 ch, INT32 X, INT32 Y, UINT32 Color) {
    UINT8 c = (UINT8)ch;
    
    if (c >= 128) return;
    
    // Dessiner chaque ligne du caractère
    for (UINT32 row = 0; row < 8; row++) {
        UINT8 bitmap = font8x8_basic[c][row];
        
        // Dessiner chaque pixel de la ligne
        for (UINT32 col = 0; col < 8; col++) {
            // CORRECTION : Lire de gauche à droite (bit 7 = pixel 0)
            if (bitmap & (1 << (7 - col))) {  // ← CHANGÉ ICI (7 - col au lieu de col)
                DrawPixelToBuffer(X + col, Y + row, Color);
            }
        }
    }
}

VOID DrawString(CHAR16* str, INT32 X, INT32 Y, UINT32 Color) {
    while (*str != L'\0') {
        DrawChar(*str, X, Y, Color);
        X += 9; // 8 pixels + 1 espace
        str++;
    }
}

// NOUVELLE FONCTION : DrawChar avec scale
VOID DrawCharScaled(CHAR16 ch, INT32 X, INT32 Y, UINT32 Color, UINT32 Scale) {
    UINT8 c = (UINT8)ch;
    
    if (c >= 128) return;
    
    // Dessiner chaque ligne du caractère
    for (UINT32 row = 0; row < 8; row++) {
        UINT8 bitmap = font8x8_basic[c][row];
        
        // Dessiner chaque pixel de la ligne
        for (UINT32 col = 0; col < 8; col++) {
            if (bitmap & (1 << (7 - col))) {
                // Dessiner un carré Scale×Scale au lieu d'un pixel
                for (UINT32 sy = 0; sy < Scale; sy++) {
                    for (UINT32 sx = 0; sx < Scale; sx++) {
                        DrawPixelToBuffer(X + (col * Scale) + sx, 
                                         Y + (row * Scale) + sy, 
                                         Color);
                    }
                }
            }
        }
    }
}

VOID DrawStringScaled(CHAR16* str, INT32 X, INT32 Y, UINT32 Color, UINT32 Scale) {
    while (*str != L'\0') {
        DrawCharScaled(*str, X, Y, Color, Scale);
        X += (8 * Scale) + Scale; // (8 pixels + 1 espace) × Scale
        str++;
    }
}

VOID DrawStringCentered(CHAR16* str, INT32 CenterX, INT32 Y, UINT32 Color) {
    UINT32 len = 0;
    CHAR16* p = str;
    while (*p != L'\0') {
        len++;
        p++;
    }
    
    // Utiliser scale 2x pour rendre le texte plus gros
    UINT32 Scale = 2;
    INT32 Width = len * (8 * Scale + Scale) - Scale;
    INT32 StartX = CenterX - (Width / 2);
    
    DrawStringScaled(str, StartX, Y, Color, Scale);
}

VOID DrawStringCenteredScaled(CHAR16* str, INT32 CenterX, INT32 Y, UINT32 Color, UINT32 Scale) {
    UINT32 len = 0;
    CHAR16* p = str;
    while (*p != L'\0') {
        len++;
        p++;
    }
    
    INT32 Width = len * (8 * Scale + Scale) - Scale;
    INT32 StartX = CenterX - (Width / 2);
    
    DrawStringScaled(str, StartX, Y, Color, Scale);
}